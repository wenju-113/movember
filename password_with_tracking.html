%%writefile password_with_tracking.html
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>密碼與姓名輸入</title>
</head>
<body>
<h2>請輸入姓名與密碼以進入扭蛋抽獎頁面</h2>

<input type="text" id="name" placeholder="您的姓名">
<br><br>

<input type="password" id="pwd" placeholder="密碼">
<button onclick="checkPassword()">進入</button>
<p id="error" style="color:red;"></p>

<script>
    // 【請務必替換成您在步驟一中部署的 Apps Script 網址】
    const GAS_URL = "https://teams.microsoft.com/l/message/48:notes/1761031316170?context=%7B%22contextType%22%3A%22chat%22%2C%22oid%22%3A%228%3Aorgid%3A128c242e-8626-4224-9934-f30b9c8c375b%22%7D"; 
    
    const correctPwd = "movember";
    const targetUrl = "https://ooopenlab.cc/quiz/ofnoD05qa8YBPaCW9ZUy";

    // 由於數據儲存需要時間，所以函式必須是非同步 (async)
    async function checkPassword() {
        const inputName = document.getElementById("name").value.trim();
        const inputPwd = document.getElementById("pwd").value;
        const errorElement = document.getElementById("error");

        errorElement.textContent = ""; // 清除舊錯誤

        if (inputName === "") {
            errorElement.textContent = "請輸入您的姓名!";
            return;
        }

        if (inputPwd !== correctPwd) {
            errorElement.textContent = "密碼錯誤，再去仔細找找漫畫中的線索吧!";
            return;
        }

        // 密碼正確，開始背景儲存資料
        errorElement.textContent = "密碼正確，正在儲存資料，請稍候..."; 
        
        try {
            // 使用 Fetch API 發送 POST 請求到 Apps Script
            const response = await fetch(GAS_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                // 將姓名包裝成 JSON 格式發送
                body: JSON.stringify({ name: inputName })
            });
            
            // 檢查網路請求是否成功
            if (!response.ok) {
                throw new Error('網路請求失敗');
            }
            
            // 檢查 Apps Script 返回的結果是否為 success: true
            const result = await response.json();
            if (result.success !== true) {
                 throw new Error('伺服器資料儲存失敗，請重試');
            }

            // --- 資料儲存成功，執行跳轉 ---
            document.body.innerHTML = '<h1>資料儲存完成！請點擊<br><a href="' + targetUrl + '" target="_top">前往扭蛋機抽獎</a></h1>'; 
            
            // 自動跳轉
            setTimeout(function() {
                 window.top.location.href = targetUrl; 
            }, 50);

        } catch (error) {
            console.error('儲存資料時發生錯誤:', error);
            // 儲存失敗則停止跳轉
            errorElement.textContent = "資料儲存失敗，請通知管理員 (錯誤: " + error.message + ")。";
        }
    }
</script>
</body>
</html>
